{{ define "main" }}
{{ $settingsAuthor := .Site.GetPage "/settings/author" -}}
<main class="site-main">
	<div class="container">
		<div class="row">
			<div class="col-md-12 offset-lg-1 col-lg-10 offset-xl-2 col-xl-8">
				<div class="post-header">
					{{ with .Params.tags }}
					<ul class="post-tags list-inline">
						{{ range . }}
						<li class="list-inline-item">
							<a class="link-main-no-underline" href="{{ partial `tag_url.html` (dict `context` $ `tag` .) }}">#{{ . }}</a>
						</li>
						{{ end }}
					</ul>
					{{ end }}
					
					<h1 class="post-title">{{ .Title }}</h1>
					
					<div class="post-meta">
						<img src="{{ $settingsAuthor.Params.image | default `/img/default-author.jpg` }}" class="rounded-circle" alt="{{ $settingsAuthor.Params.name }}">
						{{ $settingsAuthor.Params.name }} <span class="dot"></span> {{ partial "post_date.html" . }}
					</div>
				</div>
			</div>
		</div>

		<div class="row">
			<div class="col-md-12 offset-lg-1 col-lg-10 offset-xl-2 col-xl-8">
				<div class="article-content">
					{{ partial "figcaption.html" .Content }}

					{{ with .Params.footnotes }}
					<div class="footnotes">
						<hr>
						{{ . | markdownify }}
					</div>
					{{ end }}
				</div>
			</div>
		</div>
	</div>
</main>

{{- /* Related Content */}}
{{- $posts := where .Site.RegularPages "Section" "posts" }}
{{- $related := $posts.Related . | first 3 }}

{{- /* Add previous and next if no related has been found. Need to do this manually because 
	 	   .PrevInSection / .NextInSection does not work with disabled sections in config.toml. */}}
{{- if lt (len $related) 3 }}
	{{- $current := .}}
	{{- range $i, $p := $posts }}
		{{- if eq $current $p }}
			{{- if gt $i 0 }}
				{{- $next := index $posts (sub $i 1) }}
				{{- if not (in $related $next) }}
					{{- $related = $related | append $next }}
				{{- end}}
			{{- end }}
			{{- if lt $i (sub (len $posts) 1) }}
				{{- $prev := index $posts (add $i 1) }}
				{{- if not (in $related $prev) }}
					{{- $related = $related | append $prev }}
				{{- end}}
			{{- end }}
		{{- end }}
	{{- end }}
{{- end }}

{{- if $related }}
<aside class="site-related">
	<div class="site-related-inner">
		<div class="container">
			<h2>Verwandte Artikel</h2>
			<a class="link-gray-underline-hover" href="/">&larr; Alle Blogartikel</a>
			<div class="site-related-row row row-cols-1 row-cols-sm-2 row-cols-md-3 g-3">
				{{ range $index, $post := $related | first 3 }}
				{{ if le $index 1 }}
					<div class="col">
				{{ else }}
					<div class="col d-none d-md-block">
				{{ end }}
					{{ partial "post_card.html" (dict "post" $post "small" true) }}
				</div>
				{{ end }}
			</div>
		</div>
	</div>
</aside>
{{- end }}

{{ end }}